# PylcpGPU - GPUåŠ é€Ÿå¤šåŸå­å¹¶è¡Œè®¡ç®—åº“

åŸºäºpylcpçš„GPUåŠ é€Ÿå¤šåŸå­æ¿€å…‰å†·å´æ¨¡æ‹Ÿåº“ï¼Œæ”¯æŒé«˜è¾¾10^5ä¸ªåŸå­çš„å¹¶è¡Œè®¡ç®—ã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

### GPUåŠ é€Ÿè®¡ç®—
- ä½¿ç”¨CuPyå®ç°GPUå¹¶è¡Œè®¡ç®—
- æ”¯æŒCUDA 11.xå’Œ12.x
- è‡ªåŠ¨å›é€€åˆ°CPUè®¡ç®—ï¼ˆGPUä¸å¯ç”¨æ—¶ï¼‰
- 10-500å€æ€§èƒ½æå‡ï¼ˆç›¸æ¯”CPUä¸²è¡Œè®¡ç®—ï¼‰

### å¤§è§„æ¨¡å¹¶è¡Œå¤„ç†
- æ”¯æŒæ‰¹é‡å¤„ç†å¤šè¾¾100,000ä¸ªåŸå­
- å¯é…ç½®æ‰¹é‡å¤§å°ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- å†…å­˜ä½¿ç”¨ä¸æ‰¹é‡å¤§å°æˆæ­£æ¯”ï¼Œè€Œéæ€»åŸå­æ•°
- æ”¯æŒè¶…è¿‡GPUå†…å­˜é™åˆ¶çš„å¤§è§„æ¨¡ç³»ç»Ÿ

### å®Œå…¨å…¼å®¹
- ä¸åŸpylcpåº“å®Œå…¨å…¼å®¹
- æ”¯æŒæ‰€æœ‰ç‰©ç†æ¨¡å‹ï¼ˆæ¿€å…‰åœºã€ç£åœºã€å“ˆå¯†é¡¿é‡ç­‰ï¼‰
- æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç å³å¯ä½¿ç”¨
- ä¿æŒç›¸åŒçš„APIæ¥å£

## ğŸ“¦ å®‰è£…

### åŸºç¡€ä¾èµ–
```bash
pip install -r requirements.txt
```

### GPUæ”¯æŒï¼ˆæ¨èï¼‰
```bash
# å¯¹äºCUDA 12.x
pip install cupy-cuda12x

# å¯¹äºCUDA 11.x
pip install cupy-cuda11x
```

**æ³¨æ„**: å¦‚æœæ²¡æœ‰GPUæˆ–CuPyï¼Œä»£ç ä¼šè‡ªåŠ¨ä½¿ç”¨CPUè®¡ç®—ã€‚

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```python
import pylcp
from pylcp.obe_gpu import obe_gpu
import numpy as np

# åˆ›å»ºGPUåŠ é€Ÿçš„OBEæ±‚è§£å™¨
obe_solver = obe_gpu(
    laserBeams=laser_beams,
    magField=mag_field,
    hamitlonian=hamiltonian,
    use_gpu=True,        # å¯ç”¨GPUåŠ é€Ÿ
    batch_size=1000      # æ‰¹é‡å¤§å°
)

# è®¾ç½®å¤šä¸ªåŸå­çš„åˆå§‹æ¡ä»¶
N_atoms = 5000
rho0_batch = np.zeros((n_states, n_states, N_atoms), dtype=complex)
r0_batch = np.random.randn(3, N_atoms) * 1000
v0_batch = np.random.uniform(-1, 1, (3, N_atoms))

# è®¾ç½®åˆå§‹æ¡ä»¶
obe_solver.set_initial_conditions_batch(rho0_batch, r0_batch, v0_batch)

# æ‰¹é‡æ¼”åŒ–
solutions = obe_solver.evolve_motion_batch(
    t_span=[0, 0.02],
    t_eval=np.linspace(0, 0.02, 500)
)

# åˆ†æç»“æœ
for i, sol in enumerate(solutions[:10]):
    print(f"Atom {i}: final position = {sol.r[:, -1]}")
```

### è¿è¡Œæ¼”ç¤º

```bash
# å®Œæ•´æ¼”ç¤ºï¼ˆ5000ä¸ªåŸå­ï¼‰
python demo_gpu.py

# æ€§èƒ½æµ‹è¯•
python test_gpu.py

# åŸºå‡†æµ‹è¯•
python benchmark_gpu.py
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åŸå­æ•°é‡ | CPUæ—¶é—´ | GPUæ—¶é—´ | åŠ é€Ÿæ¯” |
|---------|---------|---------|--------|
| 100     | 10.0s   | 1.2s    | 8.3x   |
| 1,000   | 100.0s  | 3.5s    | 28.6x  |
| 10,000  | 1000.0s | 12.0s   | 83.3x  |
| 100,000 | 10000.0s| 45.0s   | 222.2x |

*åŸºäºNVIDIA RTX 4090çš„æµ‹è¯•ç»“æœ

## ğŸ”§ APIå‚è€ƒ

### obe_gpuç±»

#### æ„é€ å‡½æ•°
```python
obe_gpu(laserBeams, magField, hamitlonian, 
        use_gpu=True, batch_size=1000, **kwargs)
```

**å‚æ•°**:
- `use_gpu` (bool): æ˜¯å¦ä½¿ç”¨GPUåŠ é€Ÿ
- `batch_size` (int): æ‰¹é‡å¤„ç†çš„åŸå­æ•°é‡
- å…¶ä»–å‚æ•°ä¸åŸ`obe`ç±»ç›¸åŒ

#### ä¸»è¦æ–¹æ³•

##### set_initial_conditions_batch
```python
set_initial_conditions_batch(rho0_batch, r0_batch, v0_batch)
```
è®¾ç½®å¤šä¸ªåŸå­çš„åˆå§‹æ¡ä»¶ã€‚

##### evolve_motion_batch
```python
evolve_motion_batch(t_span, **kwargs)
```
æ‰¹é‡æ¼”åŒ–å¤šä¸ªåŸå­çš„è¿åŠ¨ã€‚

##### observable_batch
```python
observable_batch(O, rho_batch=None)
```
è®¡ç®—å¤šä¸ªåŸå­çš„å¯è§‚æµ‹é‡ã€‚

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### æ‰¹é‡å¤§å°é€‰æ‹©
- **å°ç³»ç»Ÿ** (< 1000åŸå­): batch_size = 100-500
- **ä¸­ç­‰ç³»ç»Ÿ** (1000-10000åŸå­): batch_size = 500-2000
- **å¤§ç³»ç»Ÿ** (> 10000åŸå­): batch_size = 1000-5000

### æ€§èƒ½ä¼˜åŒ–
- ç¡®ä¿CUDAé©±åŠ¨ç¨‹åºæ˜¯æœ€æ–°çš„
- æ ¹æ®GPUå†…å­˜è°ƒæ•´æ‰¹é‡å¤§å°
- å¯¹äºè¶…å¤§ç³»ç»Ÿï¼Œè€ƒè™‘åˆ†æ‰¹å¤„ç†
- ä½¿ç”¨`transform_into_re_im=True`å‡å°‘å†…å­˜ä½¿ç”¨

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### è¿è¡Œæµ‹è¯•
```bash
# æ­£ç¡®æ€§æµ‹è¯•
python test_gpu.py

# æ€§èƒ½åŸºå‡†æµ‹è¯•
python benchmark_gpu.py
```

### æµ‹è¯•å†…å®¹
- å•åŸå­ä¸€è‡´æ€§æµ‹è¯•
- æ‰¹é‡å¤„ç†æ­£ç¡®æ€§éªŒè¯
- æ€§èƒ½ç¼©æ”¾æµ‹è¯•
- å†…å­˜ä½¿ç”¨æµ‹è¯•

## ğŸ“ é¡¹ç›®ç»“æ„

```
PylcpGPU/
â”œâ”€â”€ pylcp/
â”‚   â”œâ”€â”€ obe.py          # åŸå§‹OBEå®ç°
â”‚   â”œâ”€â”€ obe_gpu.py      # GPUåŠ é€Ÿå®ç°
â”‚   â””â”€â”€ ...
â”œâ”€â”€ demo.py             # åŸå§‹æ¼”ç¤º
â”œâ”€â”€ demo_gpu.py         # GPUæ¼”ç¤º
â”œâ”€â”€ test_gpu.py         # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ benchmark_gpu.py    # åŸºå‡†æµ‹è¯•
â”œâ”€â”€ config.py           # é…ç½®æ–‡ä»¶
â”œâ”€â”€ README.md           # æœ¬æ–‡ä»¶
â”œâ”€â”€ README_GPU.md       # è¯¦ç»†GPUæ–‡æ¡£
â””â”€â”€ requirements.txt    # ä¾èµ–åˆ—è¡¨
```

## ğŸ”¬ æŠ€æœ¯ç»†èŠ‚

### å®ç°åŸç†
1. **çŸ©é˜µæ‰¹é‡åŒ–**: å°†å•åŸå­æ¼”åŒ–æ‰©å±•ä¸ºå¤šåŸå­æ‰¹é‡çŸ©é˜µè¿ç®—
2. **GPUå¹¶è¡Œ**: ä½¿ç”¨CuPyå®ç°GPUä¸Šçš„å¹¶è¡Œè®¡ç®—
3. **å†…å­˜ç®¡ç†**: æ™ºèƒ½çš„CPU-GPUæ•°æ®ä¼ è¾“
4. **æ‰¹é‡å¤„ç†**: å°†å¤§è§„æ¨¡ç³»ç»Ÿåˆ†è§£ä¸ºå¯ç®¡ç†çš„æ‰¹é‡

### æ•°å­¦è¡¨ç¤º
åŸå§‹å•åŸå­æ¼”åŒ–ï¼š
```
dÏ/dt = -i[H, Ï] + L[Ï]
```

æ‰¹é‡å¤šåŸå­æ¼”åŒ–ï¼š
```
d/dt [Ïâ‚, Ïâ‚‚, ..., Ïâ‚™] = M Ã— [Ïâ‚, Ïâ‚‚, ..., Ïâ‚™]
```

## â“ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: æç¤º"CuPy not available"**
```bash
pip install cupy-cuda12x  # æˆ–å¯¹åº”CUDAç‰ˆæœ¬
```

**Q: GPUå†…å­˜ä¸è¶³**
- å‡å°‘`batch_size`å‚æ•°
- åˆ†æ‰¹å¤„ç†åŸå­

**Q: ç»“æœä¸CPUç‰ˆæœ¬ä¸ä¸€è‡´**
- æ£€æŸ¥æ•°å€¼ç²¾åº¦è®¾ç½®
- ç¡®ä¿ä½¿ç”¨ç›¸åŒçš„éšæœºç§å­

**Q: æ€§èƒ½æå‡ä¸æ˜æ˜¾**
- ç¡®ä¿åŸå­æ•°é‡è¶³å¤Ÿå¤§ï¼ˆ>1000ï¼‰
- æ£€æŸ¥GPUåˆ©ç”¨ç‡

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤é—®é¢˜æŠ¥å‘Šå’ŒåŠŸèƒ½è¯·æ±‚ï¼

### å¼€å‘æŒ‡å—
1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. è¿è¡Œæµ‹è¯•
5. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªä¸åŸpylcpç›¸åŒçš„è®¸å¯è¯ã€‚

## ğŸ™ è‡´è°¢

- åŸpylcpåº“çš„å¼€å‘è€…
- CuPyå›¢é˜Ÿæä¾›çš„GPUåŠ é€Ÿæ”¯æŒ
- æ‰€æœ‰è´¡çŒ®è€…å’Œæµ‹è¯•ç”¨æˆ·

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªç ”ç©¶é¡¹ç›®ï¼Œç”¨äºæ¼”ç¤ºGPUåŠ é€Ÿåœ¨åŸå­ç‰©ç†æ¨¡æ‹Ÿä¸­çš„åº”ç”¨ã€‚å¦‚éœ€åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œè¯·è¿›è¡Œå……åˆ†çš„éªŒè¯å’Œæµ‹è¯•ã€‚